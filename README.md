# Сервис для полуавтоматической разметки товаров для ООО "Просепт"
Хакатон ноябрь-декабрь 2023 г.
### Команда №14:
- Анастасия Крицкая - предобработка данных, тестирование моделей
- Олеся Круглякова - подбор способа валидации, тестирование моделей, деплой, отчётность, оформление
- Иван Прошин - тестирование моделей, деплой

### Задача проекта

Разработка решения, которое частично автоматизирует процесс сопоставления товаров. Основная идея - предлагать несколько товаров заказчика, которые с наибольшей вероятностью соответствуют размечаемому товару дилера.  Реализуется в виде онлайн сервиса, открываемого в веб-браузере.

### Задача ML-специалистов

Разработать рекомендательную модель, которая будет предлагать несколько наиболее вероятных вариантов названия товара у заказчика к названию товара, используемомому на сайте дилера. 

### Содержание репозитория с ML-решением
- [`prosept-hack-notebook.ipynb`](https://github.com/avkrickaya/Prosept_matching/blob/main/prosept-hack-notebook.ipynb) - Ноутбук с анализом, предобработкой данных, обучением модели, валидацией 
-  [`model.py`](https://github.com/avkrickaya/Prosept_matching/blob/main/model.py): скрипт прогнозирования `model.py`
-  [`requirements.txt`](https://github.com/avkrickaya/Prosept_matching/blob/main/requirements.txt) - список требуемых зависимостей
-  `Dockerfile`, `app.py`, `settings.py` - файлы для развёртывания модели 



#### Стек технологий
`Python3` `Pandas` `Sklearn` `Numpy` `pymorphy3` `NLTK` `NLP` ``CatBoost` `sentence_transformers` `Docker`



### Инструкция по запуску скрипта 

Клонировать репозиторий

```git clone git@github.com:avkrickaya/Prosept_matching.git```   

Установить виртуальное окружение

```python3 -m venv venv```

Запустить виртуальное окружение

```source venv/bin/activate```

Установить все зависимости

```pip install -r requirements.txt```

Запустить скрипт

```python model.py <путь к json-файлу с данными с сайтов дилеров из БД > <json-файл с данными производителя из БД >```


#### Метрика качества
Особенности задачи:
- существует только одно правильное соответствующее название товара среди названий производителя
- заказчик не указал конкретное количество выводимых рекомендаций, запросил настраиваемое количество

Выбрано 5 рекомендаций как оптимальное для решения задачи и отображения для пользователя. Поэтому основная метрика качества для валидации  **accuracy@5** - рассчитывается как доля случаев, когда хотя бы одна из правильных меток присутствует в топ-5 предсказанных.  
Дополнительно оценивались accuracy@1, MRR и accuracy@10, accuracy@20 для подбора грубого поиска в двухэтапную модель. Расчёт  на всех предоставленных размеченных данных.


## Описание ML-решения 

Для подбора использовали только названия продуктов, которые предварительно предобработаны: частично устранены ошибки в написании, очищены от знаков препинания и маловажных слов, проведена лемматизация, удалены пропуски.

Протестировано несколько способов решения, где в качестве векторайзера использовались
`TfidfVectorizer`, `distilbert` и `LaBSE` из `sentence_transformers`, а для поиска подходящих названий косинусное сходство и KNN.  
Среди них выбирался один наиболее результативный по метрике accuracy@20. Приоритет был отдан алгоритму `tfidf_matcher`, а не `LaBSE + cos`, так как оба имеют похожий результат в случае предсказаний 20 рекомендаций, Accuracy@20 > 97% , но `tfidf_matcher` работает значительно быстрее.  
На финальном стадии протестирована двухэтапная модель: 
`tfidf_matcher` на первом этапе генерирует 20 предсказаний, с точностью 97%, на втором этапе `классификатор CatBoost` предсказывает вероятность соответствия каждой пары <Товар с сайта дилера - Рекомендация> , среди котторых отбираются 5 самых высоких. Такая модель имеет: 
-  Accuracy@5 = 94,2%, 
- в 79,8% случаев правильное название на 1-м месте, MRR = 0,86




## Взаимодействие 
Взаимодействие с ML- модулем в приложении будет организовано по схеме  Batch deployment:    
Предсказания модели рассчитываются с  заданной периодичностью (или при внесении изменений в базу данных). Мы предполагаем, что запуск будет осуществляться  ежедневно ночью после окончания парсинга. Результат сохраняется в базу данных и предоставляется по запросу пользователя:
![image](https://github.com/avkrickaya/Prosept_matching/assets/139965241/54661a6b-f4c9-4133-9224-dd1c981fb5d4)


 Часть | Действие
----------|----
Backend | Инициируется запуск ML-модуля по расписанию или  после окончания  парсинга|
ML + Backend | ML-модуль взаимодействует с бэкендом для получения данных таблиц marketing_product.csv и 'marketing_dealer.csv' из базы данных |
ML | ML-модуль проводит предобработку данных из таблиц и генерирует для каждой записи 5 рекомендованных названий продуктов, отправляет результаты в базу данных  |
Backend | Сгенерированные данные сохраняются в базе данных |
Frontend | Пользователь кликает на название продукта с целью сделать разметку, данные о рекомендациях приходят из базы данных|
